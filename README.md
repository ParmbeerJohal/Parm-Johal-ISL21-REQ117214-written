# Parm-Johal-ISL21-REQ117214-written

## Winter Supplement Rules Engine

The Winter Supplement Rules Engine is a Python application designed to calculate eligibility and benefit amounts for families. It uses MQTT messaging to interact with the MQTT broker hosted at test.mosquitto.org and includes a rules engine for processing input data.

---

### Table of Contents
1. [Setting Up a Development Environment](#setting-up-a-development-environment)
2. [Running the Application Locally](#running-the-application-locally)
3. [Updating the MQTT Topic ID](#updating-the-mqtt-topic-id)
4. [Running Unit Tests With Pytest](#running-unit-tests-with-pytest)
5. [Running Unit Tests With Mosquitto](#running-unit-tests-with-mosquitto)
6. [Project Structure](#project-structure)

---

### Setting Up a Development Environment

#### Prerequisites
1. **Python 3.13.0+**: Ensure you have Python installed.
2. **Pip**: Python's package manager.
3. **MQTT Broker**: The application uses the public MQTT broker `test.mosquitto.org`.
4. **Eclipse Mosquitto (optional)**: An open source message broker that can be used for basic end to end testing to mimic data sent by the winter supplement web application.
5. **Docker (optional)**: Used for containerizing the application and, in this case, make the setup process easier for running/testing.

#### Steps (with Docker)
1. Clone the repository:
   ```bash
   git clone https://github.com/ParmbeerJohal/Parm-Johal-ISL21-REQ117214-written.git
   cd Parm-Johal-ISL21-REQ117214-written
   ```

2. Build the Docker image:
   ```bash
   docker build -t winter-supplement-rules-engine-app .
   ```

#### Steps (without Docker)
1. Clone the repository:
   ```bash
   git clone https://github.com/ParmbeerJohal/Parm-Johal-ISL21-REQ117214-written.git
   cd Parm-Johal-ISL21-REQ117214-written
   ```

2. Create a virtual environment:
   ```bash
   python -m venv venv
   source venv/bin/activate  # On Windows: venv\Scripts\activate
   ```

3. Install dependencies:
   ```bash
   pip install -r docs/requirements.txt
   ```

---

### Running the Application Locally

#### Start the Application (via Docker)
1. Run the Docker container with the topic id argument:
   ```bash
   docker run --rm -it winter-supplement-rules-engine-app --topic-id <your-topic-id>
   ```
   Replace `<your-topic-id>` with the topic ID generated by the Winter Supplement web application.

2. Example:
   ```bash
   docker run --rm -it winter-supplement-rules-engine-app --topic-id 5123fd09-c862-4595-80e5-4b595fbff11c
   ```

3. The application will:
   - Subscribe to the input topic: `BRE/calculateWinterSupplementInput/<your-topic-id>`.
   - Receive input data submitted by the winter supplement web application
   - Publish results to the output topic: `BRE/calculateWinterSupplementOutput/<your-topic-id>`.

#### Start the Application (via local virtual environment)
1. Run the application with a specified MQTT topic ID:
   ```bash
   python main.py --topic-id <your-topic-id>
   ```
   Replace `<your-topic-id>` with the topic ID generated by the Winter Supplement web application.

2. Example:
   ```bash
   python main.py --topic-id 5123fd09-c862-4595-80e5-4b595fbff11c
   ```

3. The application will:
   - Subscribe to the input topic: `BRE/calculateWinterSupplementInput/<your-topic-id>`.
   - Receive input data submitted by the winter supplement web application
   - Publish results to the output topic: `BRE/calculateWinterSupplementOutput/<your-topic-id>`.

---

### Updating the MQTT Topic ID

If the topic ID changes during testing or runtime:
1. Gracefully end the application with `ctrl + c`
2. rerun the above command with the new topic ID

---

### Running Unit Tests With Pytest

#### Test Overview
The application includes unit tests for:
- The **Rules Engine** (`rules_engine.py`).
- The **MQTT Client** (`mqtt_client.py`).

#### Running Tests
1. Ensure you are in the virtual environment.
2. Use the following command to run all tests:
   ```bash
   pytest tests/
   ```

3. Expected output:
   - A report of passing and failing tests.

#### Example:
```bash
============================= test session starts ==============================
collected 10 items                                                              

tests/test_mqtt_client.py .                                            [ 10%]
tests/test_rules_engine.py .........                                   [100%]

============================== 10 passed in 0.21s ===============================
```

---

### Running Unit Tests With Mosquitto
#### Test Overview
The application can also be tested using the `mosquitto_pub` command on the command line to mimic the scenario where a user submits the form on the  winter supplement web application.

#### Running Tests
1. Start the rules engine via Docker or within your local virtual environment using your chosen topic ID.
2. In another command line, use the following command to send data to the input topic (replacing `<your-topic-id>` with your chosen topic ID):
   ```bash
   mosquitto_pub -h test.mosquitto.org -t BRE/calculateWinterSupplementInput/<your-topic-id> -m '{"id": "12345", "familyComposition": "single", "numberOfChildren": 0, "familyUnitInPayForDecember": true}'
   ```

3. Expected output:
   The expected output should be the following:
      ```bash
      Received message: {'id': '12345', 'familyComposition': 'single', 'numberOfChildren': 0, 'familyUnitInPayForDecember': True}
      Processed output: {'id': '12345', 'isEligible': True, 'baseAmount': 60.0, 'childrenAmount': 0.0, 'supplementAmount': 60.0}
      Published result to topic: BRE/calculateWinterSupplementOutput/12345
      ```

---

### Project Structure

```plaintext
Parm-Johal-ISL21-REQ117214-written/
├── docs/
│   ├── requirements.txt          # Python dependencies
|
├── src/
│   ├── rules_engine.py           # Core logic for eligibility and supplement calculation
│   ├── mqtt_client.py            # MQTT communication logic
│
├── tests/
│   ├── test_rules_engine.py      # Unit tests for rules_engine.py
│   ├── test_mqtt_client.py       # Unit tests for mqtt_client.py
│
├── main.py                       # Entry point for the application
├── Dockerfile                    # Docker configuration for containerizing the application
|── .gitignore                    # Files to ignore in version control
└── README.md                     # This file
```